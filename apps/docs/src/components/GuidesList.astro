---
import { getGuidesData } from '../utils/navigation'
import { getSidebarConfig } from '../content/config'

interface Props {
  category?: string
}

const { category: categoryProp } = Astro.props

// Extract locale from URL path (e.g., /docs/en/guides -> 'en')
const locale = Astro.url.pathname.split('/')[2] || 'en'

// Extract category from URL if not provided as prop
// e.g., /docs/en/guides/claude -> 'claude'
let category = categoryProp
if (!category) {
  const pathParts = Astro.url.pathname.split('/').filter(Boolean)
  const guidesIndex = pathParts.indexOf('guides')
  if (guidesIndex !== -1 && pathParts.length > guidesIndex + 1) {
    category = pathParts[guidesIndex + 1]
    // Don't treat 'index' as a category
    if (category === 'index') {
      category = undefined
    }
  }
}

const sidebarConfig = getSidebarConfig(locale, (key: string) => {
  try {
    return Astro.locals?.t?.(key as any) || key
  } catch {
    return key
  }
})
const guidesData = getGuidesData(sidebarConfig)

// Map category slugs to group title patterns
const categoryMap: Record<string, string[]> = {
  claude: ['Claude'],
  agentkit: ['AgentKit'],
  langchain: ['LangChain'],
  'reinforcement-learning': ['TRL', 'Reinforcement Learning'],
}

// If category is provided, filter to show only that category's guides
// Otherwise, show category links on the main index page
let filteredData = guidesData

if (category) {
  // Filter items by their href path to show only guides from the specified category
  // Since we flattened the structure, all guides are in one group, so we filter items
  filteredData = guidesData
    .map(group => {
      const filteredItems = group.items.filter(item => {
        // Normalize the href for comparison
        const normalizedHref = item.href.replace(/\/$/, '') // Remove trailing slash

        // Check if the item's href contains the category path (e.g., /guides/claude/guide-name)
        // This pattern matches: /guides/{category}/{guide-name}
        const categoryPattern = `/guides/${category}/`
        const hrefContainsCategory = normalizedHref.includes(categoryPattern)

        // Exclude the category index page itself (e.g., /guides/claude or /docs/guides/claude)
        const categoryIndexPatterns = [
          `/guides/${category}`,
          `/docs/guides/${category}`,
          `/docs/${locale}/guides/${category}`,
        ]
        const isCategoryIndex = categoryIndexPatterns.some(
          pattern =>
            normalizedHref === pattern || normalizedHref.endsWith(pattern)
        )

        return hrefContainsCategory && !isCategoryIndex
      })

      return {
        title: group.title,
        items: filteredItems,
      }
    })
    .filter(group => group.items.length > 0) // Only show groups with items
} else {
  // On main index, show all individual guides (not category links)
  // Filter out category index pages and category links
  filteredData = guidesData
    .map(group => {
      const filteredItems = group.items.filter(item => {
        // Normalize the href for comparison
        const normalizedHref = item.href.replace(/\/$/, '')

        // Exclude category index pages (e.g., /guides/claude, /guides/agentkit)
        const categoryIndexPatterns = Object.keys(categoryMap)
          .map(slug => [
            `/guides/${slug}`,
            `/docs/guides/${slug}`,
            `/docs/${locale}/guides/${slug}`,
          ])
          .flat()

        const isCategoryIndex = categoryIndexPatterns.some(
          pattern =>
            normalizedHref === pattern || normalizedHref.endsWith(pattern)
        )

        // Only show actual guide pages, not category index pages
        return !isCategoryIndex
      })

      return {
        title: group.title,
        items: filteredItems,
      }
    })
    .filter(group => group.items.length > 0) // Filter out empty groups
}
---

{
  filteredData.map(group => (
    <section>
      {group.title && (
        <>
          <br />
          <h1>{group.title}</h1>
        </>
      )}
      <ul>
        {group.items.map(item => (
          <a href={item.href}>
            <li>
              <span class="document-title">{item.title}</span>
              {item.subtitle && (
                <>
                  <span class="subtitle">{item.subtitle}</span>
                </>
              )}
            </li>
          </a>
        ))}
      </ul>
    </section>
  ))
}

<style>
  section {
    all: unset;
  }

  h1 {
    all: unset;
    font-family: 'Berkeley Mono', monospace;
    font-weight: 700;
    font-size: 2em;
  }

  ul {
    all: unset;
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1em;
  }

  a {
    display: block;
    width: 100%;
    height: 100%;
    background: var(--block-bg-color);
    border: var(--border);
    border-color: var(--block-bg-color);
    border-radius: 4px;
    transition: all 0.2s ease;
    text-decoration: none;
  }

  a:hover {
    background: var(--secondary-text-color);
    border-color: var(--secondary-text-color);
  }

  li {
    display: inline-block;
    padding: 1em;
    width: 100%;
    height: 100%;
  }

  .document-title {
    font-weight: bold;
    display: block;
    margin-bottom: 0.8em;
  }

  .subtitle {
    font-weight: normal;
    font-size: 0.9em;
  }
</style>
