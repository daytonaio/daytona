---
title: Claude Agent SDK と Daytona を使ってコーディングエージェントを構築する
description: Claude Code と Daytona のサンドボックスを用いて自律型コーディングエージェントを構築するための手順ガイド。
---

import { Image } from 'astro:assets'

import claudeAgentSDKInteractiveTerminalSandboxResult from '../../../assets/docs/images/claude-agent-sdk-interactive-terminal-sandbox-result.gif'

このガイドでは、Daytona のサンドボックス環境内で [Claude Code](https://code.claude.com/docs/en/overview) をベースにした自律的なコーディングエージェントを実行する方法を説明します。エージェントは [Claude Agent SDK](https://platform.claude.com/docs/en/agent-sdk/overview) を使用して、ユーザーからのプロンプトに従います。

このエージェントは、フルスタック Web アプリケーションの開発、あらゆる言語でのコード記述、依存関係のインストール、スクリプトの実行が可能です。また、開発サーバーの起動と管理や、稼働中のアプリケーション向けのプレビューリンクの生成も行えます。

***

### 1. ワークフロー概要 \{#1-workflow-overview\}

メインモジュールを起動すると、Daytonaのサンドボックスが作成され、その中でPythonエージェントが初期化されます。エージェントは [Claude Agent SDK](https://platform.claude.com/docs/en/agent-sdk/overview) をベースとしています。

メインプログラムとはコマンドラインのチャットインターフェースを通じて対話します。プログラムはサンドボックス内のエージェントにプロンプトを送信し、エージェントがそれを実行して結果を返します。

<details>
  <summary>クリックしてワークフロー例を表示</summary>

  <div>
    ```
    $ npm run start                                   174s
    Creating sandbox...
    Installing Agent SDK...
    Initializing Agent SDK...
    Press Ctrl+C at any time to exit.
    User: Build a Zelda-like game where I can move around the screen and talk to famous programmers
    Thinking...
    I'll build a Zelda-like game for you! This will be a fun project with player movement and NPC interactions with famous programmers.
    🔨 Write
    🔨 Write
    Now let me start a simple HTTP server to host the game:
    🔨 Bash
    Perfect! I've created a Zelda-like game called "Programmer's Quest" for you! 🎮

    ## Game Features:

    ✨ Zelda-style gameplay:
    - Top-down 2D view with classic retro aesthetics
    - Player character with sword and shield
    - Grid-based movement system
    - Environmental obstacles (trees and rocks)

    👥 Famous Programmers as NPCs:
    1. Linus Torvalds - Creator of Linux
    2. Grace Hopper - COBOL pioneer and Admiral
    3. Alan Turing - Father of computer science
    4. Ada Lovelace - First computer programmer
    5. Dennis Ritchie - Creator of C and UNIX

    🎮 Controls:
    - Arrow Keys or WASD - Move your character
    - SPACE - Talk to NPCs when you're near them

    🌟 Gameplay:
    - Explore the grassy map and find all 5 legendary programmers
    - Each NPC has multiple quotes that cycle when you talk to them
    - NPCs glow when you're near them
    - Dialog boxes appear with their famous quotes
    - Track your progress in the HUD

    ## Play Now:
    🎯 [Click here to play the game!](https://80-8e2c4d23-212a-4f1e-bb6c-abfa71aeed3a.proxy.daytona.works)

    The game features smooth movement, collision detection with trees and rocks, and an immersive dialog system. Try to find and talk to all 5 famous programmers to learn their wisdom! Each has 3 different quotes that cycle as you keep talking to them.

    Enjoy your adventure! 🗡️✨
    User:
    ```
  </div>
</details>

エージェントはWebアプリをホストし、[Daytona Preview Links](https://www.daytona.io/docs/en/preview-and-authentication/) 機能を使用してプレビューリンクを提供することもできます。タスクにWebアプリケーションの実行やプレビューが含まれる場合、エージェントはその必要性を自動的に判断し、アプリをホストして、実行中の結果を確認するためのプレビューリンクを生成します。

<Image src={claudeAgentSDKInteractiveTerminalSandboxResult} alt="コーディングエージェントによって生成されたRPGゲームのデモ" width={600} style="max-width: 100%; height: auto; margin: 1rem 0;" />

作業が完了するまで、エージェントとの対話を継続できます。プログラムを終了すると、サンドボックスは自動的に削除されます。

### 2. プロジェクトのセットアップ \{#2-project-setup\}

#### リポジトリをクローンする \{#clone-the-repository\}

まず、Daytona の[リポジトリ](https://github.com/daytonaio/daytona.git)をクローンし、example ディレクトリに移動します。

```bash
git clone https://github.com/daytonaio/daytona.git
cd daytona/guides/typescript/claude-agent-sdk
```

#### 環境を設定する \{#configure-environment\}

API キーを取得します：

* **Daytona API キー：** [Daytona Dashboard](https://app.daytona.io/dashboard/keys)
* **Anthropic API キー：** [Anthropic Console](https://console.anthropic.com/)

`.env.example` を `.env` にコピーし、取得したキーを追加します：

```bash
DAYTONA_API_KEY=your_daytona_key
SANDBOX_ANTHROPIC_API_KEY=your_anthropic_key
```

:::caution[APIキーのセキュリティ]
注意: `SANDBOX_ANTHROPIC_API_KEY` キーは Daytona のサンドボックス環境に渡され、サンドボックス内で実行されるすべてのコードからアクセス可能になります。
:::

#### ローカルでの利用 \{#local-usage\}

:::note[Node.js のバージョン]
この例を実行するには Node.js 18 以降が必要です。続行する前に、お使いの環境がこの要件を満たしていることを確認してください。
:::

依存関係をインストールします:

```bash
npm install
```

エージェントを実行する：

```bash
npm run start
```

エージェントが起動し、プロンプトの入力を待ちます。

### 3. 利用例 \{#3-example-usage\}

チャットセッションの例:

<details>
  <summary>クリックしてチャットセッションの例を表示</summary>

  <div>
    ```
    $ npm run start
    Creating sandbox...
    Installing Agent SDK...
    Initializing Agent SDK...
    Press Ctrl+C at any time to exit.
    User: Svelte で楽しいペットショップのランディングページを作成して
    Thinking...
    Svelte で楽しいペットショップのランディングページを作成します！まずはプロジェクトをセットアップし、アニメーションとカラフルなデザインで魅力的なランディングページを構築します。
    🔨 Bash
    🔨 Bash
    では、アニメーション、カラフルなセクション、インタラクティブな要素を備えた、楽しく魅力的なペットショップのランディングページを作成します:
    🔨 Read
    > 🔨 Write
    では、コンポーネントファイルを作成します:
    🔨 Write
    🔨 Write
    🔨 Write
    🔨 Write
    🔨 Write
    次に、メインの CSS ファイルを更新し、開発サーバーを起動します:
    🔨 Read
    🔨 Write
    それでは、開発サーバーを起動します:
    🔨 Bash
    🔨 TaskOutput
    完了です！ 🎉 Svelte で楽しくカラフルなペットショップのランディングページを作成しました。構成は次のとおりです:

    ## 機能:

    ✨ ヒーローセクション

    - アニメーション付きの美しいグラデーション背景とフローティングカード
    - 目を引くナビゲーションバー
    - ホバー効果付きの CTA ボタン
    - 跳ねる絵文字アニメーション

    🎯 特徴セクション

    - 4 つの主なメリット（送料無料、プレミアム品質、特別オファー、受賞歴）
    - ホバーアニメーション付きのインタラクティブなカード
    - ホバー時に回転・拡大するアイコン

    🛍️ 商品セクション

    - カラフルな背景を持つ 6 つの注目商品
    - 星による評価表示
    - カートに追加する機能
    - なめらかなホバーアニメーション

    📧 ニュースレターセクション

    - ペットの絵文字が浮かぶ鮮やかなグラデーション背景
    - メール購読フォーム
    - 成功メッセージのアニメーション
    - 特別な 20% オフオファー

    👣 フッター

    - 充実したナビゲーションリンク
    - ソーシャルメディアアイコン
    - ダークグラデーションデザイン

    ## ライブプレビュー:

    あなたのペットショップは現在次の URL で稼働しています: https://80-b3739199-d90e-4bde-ab18-450d74c950e8.proxy.daytona.works

    このページには次の要素が含まれています:

    - スムーズなスクロール挙動
    - モバイル端末向けのレスポンシブデザイン
    - ページ全体にわたる楽しいアニメーション
    - ホバー効果を備えたインタラクティブな要素
    - カラフルなグラデーションとモダンなスタイリング
    - 遊び心のある絵文字ベースのアイコン

    リンクをクリックして、楽しいペットショップのランディングページを実際にご覧ください！ 🐾
    User:

    ```
  </div>
</details>

### 4. エージェントのアーキテクチャを理解する \{#4-understanding-the-agents-architecture\}

この例は、2つの主要なコンポーネントから構成されます。

* **メインプログラム:** メインプログラムはローカルマシン上で動作する Node.js スクリプト (`index.ts`) です。Daytona SDK を使用して Daytona サンドボックスを作成および管理します。メインプログラムは、サンドボックス内のエージェントと対話するためのコマンドラインインターフェースを提供します。
* **サンドボックスエージェント:** サンドボックスエージェントは Daytona サンドボックス内で動作する Python スクリプト (`coding_agent.py`) です。Claude Agent SDK を使用して、Claude Code に似たカスタマイズされたコーディングエージェントを作成します。

#### 初期化 \{#initialization\}

初期化時に、メインプログラムは次の処理を行います。

1. 環境変数に使用する Anthropic API キーを含めて、新しい [Daytona sandbox](/docs/ja/sandbox-management) を作成します。
2. [process execution](/docs/ja/process-code-execution#process-execution) を用いてサンドボックス内で `pip install` を実行し、Claude Agent SDK をインストールします。
3. 新しい [code interpreter context](/docs/ja/process-code-execution#stateful-code-interpreter) を作成します。
4. [file uploading](/docs/file-system-operations#uploading-a-single-file) を使ってコーディングエージェントのスクリプトをサンドボックスにアップロードします。
5. code interpreter context 内で `import coding_agent` を実行し、Claude Agent SDK を初期化します。
6. ユーザー入力を待ち、以下のように code interpreter context 内のエージェントにプロンプトを送信します。

#### メインプログラムのコード \{#main-program-code\}

エージェントが実行されると、プログラムはユーザー入力を読み取るための `readline` インターフェースを作成し、その入力をエージェントに送信します。
各ユーザーからのリクエストは、コードインタープリタのコンテキスト内で Python コマンドを実行することでエージェントに渡されます。

```typescript
 const result = await sandbox.codeInterpreter.runCode(
  `coding_agent.run_query_sync(os.environ.get('PROMPT', ''))`,
  {
    context: ctx,
    envs: { PROMPT: prompt },
    onStdout,
    onStderr,
  }
);
```

`onStdout` と `onStderr` のコールバックは、エージェントの出力をメインプログラムへ渡すために使用されます。エージェントがプロンプトに対する応答処理を終えると、メインプログラムは次のユーザー入力を待機します。

#### サンドボックスエージェントのコード \{#sandbox-agent-code\}

サンドボックスエージェントは、[Claude Agent SDK](https://platform.claude.com/docs/en/agent-sdk/overview) を使用して、Claude Code をベースにしたカスタマイズされたコーディングエージェントを作成します。
エージェントは、ワークスペースディレクトリと [プレビュー URL 形式](/docs/ja/preview-and-authentication) の例を含むシステムプロンプトで初期化されます。

```python
system_prompt = """
You are running in a Daytona sandbox.
Use the /home/daytona directory instead of /workspace for file operations.
Your public preview URL for port 80 is: {}.
""".format(preview_url)
```

また、エージェントが使用する[ツールと権限モード](https://platform.claude.com/docs/en/agent-sdk/quickstart#key-concepts)も指定します。

```python
client = ClaudeSDKClient(
  options=ClaudeAgentOptions(
    allowed_tools=["Read", "Edit", "Glob", "Grep", "Bash"],
    permission_mode="acceptEdits",
    system_prompt=system_prompt
  )
)
```

クエリを実行して応答を受け取るコードは、Anthropic の [Claude Agent Python SDK ドキュメント](https://platform.claude.com/docs/en/agent-sdk/python) に掲載されているサンプルコードに基づいています。

#### クリーンアップ \{#clean-up\}

メインプログラムを終了すると、Daytona のサンドボックスとすべてのファイルは自動的に削除されます。

**主な利点:**

* Daytona のサンドボックス上での安全かつ隔離された実行
* ターミナルからエージェントと直接対話できます
* 開発サーバーの自動検出とライブなプレビューリンク
* 複数の言語およびフルスタックのサポート
* シンプルなセットアップと自動クリーンアップ