---
title: AIでデータを分析する
description: Daytona を使用して、データ分析と可視化のためのAI生成コードを実行します。
---

import { TabItem, Tabs } from '@astrojs/starlight/components'
import { Image } from 'astro:assets'

import chartImage from '../../../assets/docs/images/chart-0.png'

Daytona のサンドボックスを使って、AI 生成コードを実行し、データを分析できます。一般的な AI データ分析のワークフローは次のとおりです。

1. ユーザーが CSV などの形式でデータセットを用意します。
2. ユーザーのデータに基づいて、LLM にコード（通常は Python）の生成を指示します。
3. サンドボックスが AI 生成コードを実行し、結果を返します。
4. その結果をユーザーに表示します。

***

## Daytona で AI データアナリストを構築する \{#build-an-ai-data-analyst-with-daytona\}

この例では、Daytona のセキュアなサンドボックス環境を用いて、CSV データから自動的に洞察と可視化を生成する AI 搭載のデータアナリストの構築方法を説明します。

**今回構築するもの:** 車両評価データセットを分析し、製造年と価格の関係を把握し、プロフェッショナルな可視化を生成するシステムです—すべてを Claude への自然言語プロンプトだけで実行します。

### 1. プロジェクトのセットアップ \{#1-project-setup\}

#### 1.1 依存関係のインストール \{#11-install-dependencies\}

Daytona SDK と Anthropic SDK をプロジェクトにインストールします。

<Tabs syncKey="language">
  <TabItem label="Python" icon="seti:python">
    `bash pip install daytona anthropic python-dotenv `
  </TabItem>

  <TabItem label="TypeScript" icon="seti:typescript">
    `bash npm install @daytonaio/sdk @anthropic-ai/sdk dotenv `
  </TabItem>
</Tabs>

#### 1.2 環境の設定 \{#12-configure-environment\}

API キーを取得し、環境を構成します:

1. **Daytona の API キー:** [Daytona Dashboard](https://app.daytona.io/dashboard/keys) から取得
2. **Anthropic の API キー:** [Anthropic Console](https://console.anthropic.com/) から取得

プロジェクトに `.env` ファイルを作成します:

```bash
DAYTONA_API_KEY=dtn_***
ANTHROPIC_API_KEY=sk-ant-***
```

### 2. データセット準備 \{#2-dataset-preparation\}

#### 2.1 データセットのダウンロード \{#21-download-dataset\}

車両評価に関する公開データセットを使用します。次のリンクから直接ダウンロードできます。

[https://download.daytona.io/dataset.csv](https://download.daytona.io/dataset.csv)

ファイルをダウンロードし、プロジェクトディレクトリ内に `dataset.csv` として保存してください。

#### 2.2 サンドボックスの初期化 \{#22-initialize-sandbox\}

Daytona のサンドボックスを作成し、データセットをアップロードします。

<Tabs syncKey="language">
  <TabItem label="Python" icon="seti:python">
    ```python
    from dotenv import load_dotenv
    from daytona import Daytona
    import os

    load_dotenv()

    # サンドボックスを作成
    daytona = Daytona()
    sandbox = daytona.create()

    # データセットをサンドボックスにアップロード
    sandbox.fs.upload_file("dataset.csv", "/home/daytona/dataset.csv")

    ```
  </TabItem>

  <TabItem label="TypeScript" icon="seti:typescript">
    ```typescript
    import 'dotenv/config'
    import { Daytona } from '@daytonaio/sdk';

    // サンドボックスを作成
    const daytona = new Daytona();
    const sandbox = await daytona.create()

    // データセットをサンドボックスにアップロード
    await sandbox.fs.uploadFile('dataset.csv', '/home/daytona/dataset.csv')
    ```
  </TabItem>
</Tabs>

### 3. AIデータアナリストの構築 \{#3-building-the-ai-data-analyst\}

ここでは、Claude と Daytona を連携させてデータを分析し、可視化を生成するための中核機能を実装します。

#### 3.1 コード実行ハンドラー \{#31-code-execution-handler\}

まず、コードの実行とチャート抽出を行う関数を作成します:

<Tabs syncKey="language">
  <TabItem label="Python" icon="seti:python">
    ```python
    import base64

    def run_ai_generated_code(sandbox, ai_generated_code):
      execution = sandbox.process.code_run(ai_generated_code)
      if execution.exit_code != 0:
        print('AI-generated code had an error.')
        print(execution.exit_code)
        print(execution.result)
        return

      # Check for charts in execution artifacts
      if not execution.artifacts or not execution.artifacts.charts:
        print('No charts found in execution artifacts')
        return

      result_idx = 0
      for result in execution.artifacts.charts:
        if result.png: # Save the png to a file (png is in base64 format)
          with open(f'chart-{result_idx}.png', 'wb') as f:
            f.write(base64.b64decode(result.png))
            print(f'Chart saved to chart-{result_idx}.png')
            result_idx += 1

    ```
  </TabItem>

  <TabItem label="TypeScript" icon="seti:typescript">
    ```typescript
    import fs from 'fs'

    async function runAIGeneratedCode(sandbox, aiGeneratedCode: string) {
      const execution = await sandbox.process.codeRun(aiGeneratedCode)
      if (execution.exitCode != 0) {
        console.error('AI-generated code had an error.')
        console.log(execution.exitCode)
        console.log(execution.result)
        return
      }

      // Check for charts in execution artifacts
      if (!execution.artifacts || !execution.artifacts.charts) {
        console.log('No charts found in execution artifacts')
        return
      }

      let resultIdx = 0
      for (const result of execution.artifacts.charts) {
        if (result.png) {
          // Save the png to a file (png is in base64 format)
          fs.writeFileSync(`chart-${resultIdx}.png`, result.png, { encoding: 'base64' })
          console.log(`Chart saved to chart-${resultIdx}.png`)
          resultIdx++
        }
      }
    }
    ```
  </TabItem>
</Tabs>

#### 3.2 分析用プロンプトの作成 \{#32-creating-the-analysis-prompt\}

次に、データセットの内容と必要な分析を Claude に伝えるプロンプトを作成します。このプロンプトには次が含まれます:

* データセットのスキーマと列の説明
* 具体的な分析リクエスト（製造年ごとの平均価格の推移）
* コード生成に関する指示

<Tabs syncKey="language">
  <TabItem label="Python" icon="seti:python">
    ```python
    from anthropic import Anthropic

    prompt = f"""
    I have a CSV file with vehicle valuations saved in the sandbox at /home/daytona/dataset.csv.

    Relevant columns:
    - 'year': integer, the manufacturing year of the vehicle
    - 'price_in_euro': float, the listed price of the vehicle in Euros

    Analyze how price varies by manufacturing year.  
    Drop rows where 'year' or 'price_in_euro' is missing, non-numeric, or an outlier.  
    Create a line chart showing average price per year.
    Write Python code that analyzes the dataset based on my request and produces right chart accordingly.
    Finish with a plt.show()"""

    anthropic = Anthropic()
    print('Waiting for the model response...')

    ```
  </TabItem>

  <TabItem label="TypeScript" icon="seti:typescript">
    ```typescript
    import Anthropic from '@anthropic-ai/sdk'

    const prompt = `
    I have a CSV file with vehicle valuations saved in the sandbox at /home/daytona/dataset.csv.

    Relevant columns:
    - 'year': integer, the manufacturing year of the vehicle
    - 'price_in_euro': float, the listed price of the vehicle in Euros

    Analyze how price varies by manufacturing year.  
    Drop rows where 'year' or 'price_in_euro' is missing, non-numeric, or an outlier.  
    Create a line chart showing average price per year.
    Write Python code that analyzes the dataset based on my request and produces right chart accordingly.
    Finish with a plt.show()`

    const anthropic = new Anthropic({ apiKey: process.env.ANTHROPIC_API_KEY })
    console.log('Waiting for the model response...')
    ```
  </TabItem>
</Tabs>

#### 3.3 ツール呼び出しのセットアップ \{#33-tool-calling-setup\}

ここでは、ツール呼び出しを使ってClaudeをDaytonaのサンドボックスに接続します。これにより、Claudeが生成したPythonコードを自動で実行できるようになります。

<Tabs syncKey="language">
  <TabItem label="Python" icon="seti:python">
    ```python
    msg = anthropic.messages.create(
        model='claude-3-5-sonnet-20240620',
        max_tokens=1024,
        messages=[{'role': 'user', 'content': prompt}],
        tools=[
            {
                'name': 'run_python_code',
                'description': 'Run Python code',
                'input_schema': {
                    'type': 'object',
                    'properties': {
                        'code': {
                            'type': 'string',
                            'description': 'The Python code to run',
                        },
                    },
                    'required': ['code'],
                },
            },
        ],
    )
    ```
  </TabItem>

  <TabItem label="TypeScript" icon="seti:typescript">
    ```typescript
    const msg = await anthropic.messages.create({
      model: 'claude-3-5-sonnet-20240620',
      max_tokens: 1024,
      messages: [{ role: 'user', content: prompt }],
      tools: [
        {
          name: 'run_python_code',
          description: 'Run Python code',
          input_schema: {
            type: 'object',
            properties: {
              code: {
                type: 'string',
                description: 'The Python code to run',
              },
            },
            required: ['code'],
          },
        },
      ],
    })
    ```
  </TabItem>
</Tabs>

#### 3.4 応答の処理 \{#34-response-processing\}

最後に、Claude の応答をパースし、Daytona のサンドボックス内で生成コードを実行します:

<Tabs syncKey="language">
  <TabItem label="Python" icon="seti:python">
    ```python
    for content_block in msg.content:
        if content_block.type == 'tool_use':
            if content_block.name == 'run_python_code':
                code = content_block.input['code']
                print('Will run following code in the Sandbox:\n', code)
                # Execute the code in the sandbox
                run_ai_generated_code(sandbox, code)
    ```
  </TabItem>

  <TabItem label="TypeScript" icon="seti:typescript">
    ```typescript
    interface CodeRunToolInput {
      code: string
    }

    for (const contentBlock of msg.content) {
      if (contentBlock.type === 'tool_use') {
        if (contentBlock.name === 'run_python_code') {
          const code = (contentBlock.input as CodeRunToolInput).code
          console.log('Will run following code in the Sandbox:\n', code)
          // Execute the code in the sandbox
          await runAIGeneratedCode(sandbox, code)
        }
      }
    }

    ```
  </TabItem>
</Tabs>

以上です。作成した `run_ai_generated_code` 関数は、チャートの保存を自動で処理します。Claude が `plt.show()` で可視化を生成すると、Daytona はそれをチャートのアーティファクトとして取得し、PNG ファイルとして保存します。

**このアプローチの主な利点:**

* **安全な実行:** コードは分離された Daytona のサンドボックスで実行されます
* **アーティファクトの自動取得:** チャート、テーブル、出力を自動的に抽出
* **エラーハンドリング:** 組み込みのエラー検出とログ記録
* **言語非依存:** ここでは Python を使用しましたが、Daytona は複数の言語をサポートします

### 4. 分析を実行する \{#4-running-your-analysis\}

これで、結果を確認するためにコード全体を実行できます。

<Tabs syncKey="language">
  <TabItem label="Python" icon="seti:python">
    ```bash
    python data-analysis.py
    ```
  </TabItem>

  <TabItem label="TypeScript" icon="seti:typescript">
    ```bash
    npx tsx data-analysis.ts
    ```
  </TabItem>
</Tabs>

プロジェクトディレクトリに、次のようなグラフが生成されるはずです：

<Image src={chartImage} alt="製造年別の車両評価のグラフ" width={600} style="max-width: 100%; height: auto; margin: 1rem 0;" />

### 5. 完全な実装 \{#5-complete-implementation\}

以下は、すぐに実行できる完成済みのサンプルです。

<Tabs syncKey="language">
  <TabItem label="Python" icon="seti:python">
    ```python
    import base64
    from dotenv import load_dotenv
    from daytona import Daytona, Sandbox
    from anthropic import Anthropic


    def main():
        load_dotenv()
        # サンドボックスを作成
        daytona = Daytona()
        sandbox = daytona.create()
        
        # データセットをサンドボックスにアップロード
        sandbox.fs.upload_file("dataset.csv", "/home/daytona/dataset.csv")
        
        prompt = f"""
    サンドボックスの /home/daytona/dataset.csv に車両評価額のCSVファイルが保存されています。

    関連する列:
    - 'year': 整数型、車両の製造年
    - 'price_in_euro': 浮動小数点型、車両の表示価格(ユーロ)

    製造年ごとの価格変動を分析してください。
    'year' または 'price_in_euro' が欠損値、非数値、または外れ値である行を削除してください。
    年ごとの平均価格を示す折れ線グラフを作成してください。
    この要求に基づいてデータセットを分析し、適切なグラフを生成するPythonコードを記述してください。
    最後に plt.show() を実行してください。"""

        anthropic = Anthropic()
        print('モデルの応答を待機中...')
        msg = anthropic.messages.create(
            model='claude-3-5-sonnet-20240620',
            max_tokens=1024,
            messages=[{'role': 'user', 'content': prompt}],
            tools=[
                {
                    'name': 'run_python_code',
                    'description': 'Pythonコードを実行',
                    'input_schema': {
                        'type': 'object',
                        'properties': {
                            'code': {
                                'type': 'string',
                                'description': '実行するPythonコード',
                            },
                        },
                        'required': ['code'],
                    },
                },
            ],
        )

        for content_block in msg.content:
            if content_block.type == 'tool_use':
                if content_block.name == 'run_python_code':
                    code = content_block.input['code']
                    print('サンドボックス内で以下のコードを実行します:\n', code)
                    # サンドボックス内でコードを実行
                    run_ai_generated_code(sandbox, code)


    def run_ai_generated_code(sandbox: Sandbox, ai_generated_code: str):
        execution = sandbox.process.code_run(ai_generated_code)
        if execution.exit_code != 0:
            print('AI生成コードでエラーが発生しました。')
            print(execution.exit_code)
            print(execution.result)
            return
        
        # すべての結果を反復処理し、グラフを表すpngファイルを確認
        if not execution.artifacts or not execution.artifacts.charts:
            print('実行アーティファクト内にグラフが見つかりませんでした')
            print(execution.artifacts)
            return

        result_idx = 0
        for result in execution.artifacts.charts:
            if result.png:
                # pngをファイルに保存
                # pngはbase64形式
                with open(f'chart-{result_idx}.png', 'wb') as f:
                    f.write(base64.b64decode(result.png))
                print(f'グラフを chart-{result_idx}.png に保存しました')
                result_idx += 1


    if __name__ == "__main__":
        main()
    ```
  </TabItem>

  <TabItem label="TypeScript" icon="seti:typescript">
    ```typescript
    import 'dotenv/config'
    import fs from 'fs'
    import Anthropic from '@anthropic-ai/sdk'
    import { Daytona, Sandbox } from '@daytonaio/sdk';


    async function main() {
      // サンドボックスを作成
      const daytona = new Daytona();
      const sandbox = await daytona.create()

      // データセットをサンドボックスにアップロード
      await sandbox.fs.uploadFile('dataset.csv', '/home/daytona/dataset.csv')

      const prompt = `
    /home/daytona/dataset.csvのサンドボックス内に車両評価額のCSVファイルが保存されています。

    関連する列:
    - 'year': 整数型、車両の製造年
    - 'price_in_euro': 浮動小数点型、車両の表示価格(ユーロ)

    製造年ごとの価格変動を分析してください。
    'year'または'price_in_euro'が欠損値、非数値、または外れ値である行を削除してください。
    年ごとの平均価格を示す折れ線グラフを作成してください。
    この要求に基づいてデータセットを分析し、適切なグラフを生成するPythonコードを記述してください。
    最後にplt.show()で終了してください。`

      const anthropic = new Anthropic({ apiKey: process.env.ANTHROPIC_API_KEY })
      console.log('モデルの応答を待機中...')
      const msg = await anthropic.messages.create({
        model: 'claude-3-5-sonnet-20240620',
        max_tokens: 1024,
        messages: [{ role: 'user', content: prompt }],
        tools: [
          {
            name: 'run_python_code',
            description: 'Pythonコードを実行',
            input_schema: {
              type: 'object',
              properties: {
                code: {
                  type: 'string',
                  description: '実行するPythonコード',
                },
              },
              required: ['code'],
            },
          },
        ],
      })

      interface CodeRunToolInput {
        code: string
      }

      for (const contentBlock of msg.content) {
        if (contentBlock.type === 'tool_use') {
          if (contentBlock.name === 'run_python_code') {
            const code = (contentBlock.input as CodeRunToolInput).code
            console.log('サンドボックス内で以下のコードを実行します:\n', code)
            // サンドボックス内でコードを実行
            await runAIGeneratedCode(sandbox, code)
          }
        }
      }
    }

    async function runAIGeneratedCode(sandbox: Sandbox, aiGeneratedCode: string) {
      const execution = await sandbox.process.codeRun(aiGeneratedCode)
      if (execution.exitCode != 0) {
        console.error('AI生成コードでエラーが発生しました。')
        console.log(execution.exitCode)
        console.log(execution.result)
        process.exit(1)
      }
      // すべての結果を反復処理し、グラフを表すpngファイルを確認
      if (!execution.artifacts || !execution.artifacts.charts) {
        console.log('実行アーティファクト内にグラフが見つかりませんでした')
        console.log(execution.artifacts)
        return
      }

      let resultIdx = 0
      for (const result of execution.artifacts.charts) {
        if (result.png) {
          // pngをファイルに保存
          // pngはbase64形式
          fs.writeFileSync(`chart-${resultIdx}.png`, result.png, { encoding: 'base64' })
          console.log(`グラフをchart-${resultIdx}.pngに保存しました`)
          resultIdx++
        }
      }
    }

    main().catch(console.error);
    ```
  </TabItem>
</Tabs>