---
title: 宣言的ビルダー
---

import { TabItem, Tabs } from '@astrojs/starlight/components'

Daytona の宣言的ビルダーは、サンドボックスの依存関係を定義するための強力な「コードファースト」アプローチを提供します。コンテナレジストリからイメージを取り込むのではなく、SDK を使ってプログラム的に定義できます。

## 概要 \{#overview\}

宣言的ビルダーシステムは、主に次の2つのワークフローをサポートします：

1. [**宣言的イメージ**](#declarative-image-building)：サンドボックスの作成時に、異なる依存関係を持つイメージをオンデマンドでビルドする
2. [**事前構築済みスナップショット**](#creating-pre-built-snapshots)：複数のサンドボックス間で共有可能な、すぐに使用できる[スナップショット](/docs/snapshots)を作成して登録する

### 宣言的イメージのビルド \{#declarative-image-building\}

サンドボックス作成時に、宣言的イメージをその場で生成できます。これは、別途スナップショットを作らずに素早く反復するのに最適です。

宣言的イメージは24時間キャッシュされ、同じスクリプトを実行する際に自動的に再利用されます。したがって、同一ランナーでの以後の実行はほぼ瞬時に完了します。

<Tabs syncKey="language">
  <TabItem label="Python" icon="seti:python">
    ```python
    # Pythonパッケージを含むシンプルな宣言的イメージを定義
    declarative_image = (
        Image.debian_slim("3.12")
        .pip_install(["requests", "pytest"])
        .workdir("/home/daytona")
    )

    # 宣言的イメージで新しいサンドボックスを作成し、ビルドログをストリーミング
    sandbox = daytona.create(
        CreateSandboxFromImageParams(image=declarative_image),
        timeout=0,
        on_snapshot_create_logs=print,
    )
    ```
  </TabItem>

  <TabItem label="TypeScript" icon="seti:typescript">
    ```typescript
    // Pythonパッケージを含むシンプルな宣言的イメージを定義
    const declarativeImage = Image.debianSlim('3.12')
      .pipInstall(['requests', 'pytest'])
      .workdir('/home/daytona')

    // 宣言的イメージで新しいサンドボックスを作成し、ビルドログをストリーミング
    const sandbox = await daytona.create(
      {
        image: declarativeImage,
      },
      {
        timeout: 0,
        onSnapshotCreateLogs: console.log,
      }
    )
    ```
  </TabItem>
</Tabs>

参照: [CreateSandboxFromImageParams (Python SDK)](/docs/python-sdk/sync/daytona#createsandboxfromimageparams), [CreateSandboxFromImageParams (TypeScript SDK)](/docs/typescript-sdk/daytona#createsandboxfromimageparams)

### 事前構築済みスナップショットの作成 \{#creating-pre-built-snapshots\}

複数のサンドボックスで再利用するイメージには、事前構築済みのスナップショットを作成します。作成したスナップショットはDaytonaダッシュボードに表示され、恒久的にキャッシュされるため、再ビルドなしで即座に利用できます。

<Tabs syncKey="language">
  <TabItem label="Python" icon="seti:python">
    ```python
    # シンプルなPythonのデータサイエンス用イメージを作成
    snapshot_name = "data-science-snapshot"

    image = (
        Image.debian_slim("3.12")
        .pip_install(["pandas", "numpy"])
        .workdir("/home/daytona")
    )

    # スナップショットを作成し、ビルドログをストリーム出力
    daytona.snapshot.create(
        CreateSnapshotParams(
            name=snapshot_name,
            image=image,
        ),
        on_logs=print,
    )

    # 事前構築済みのスナップショットから新しいサンドボックスを作成
    sandbox = daytona.create(
      CreateSandboxFromSnapshotParams(snapshot=snapshot_name)
    )
    ```
  </TabItem>

  <TabItem label="TypeScript" icon="seti:typescript">
    ```typescript
    // シンプルなPythonのデータサイエンス用イメージを作成
    const snapshotName = 'data-science-snapshot'

    const image = Image.debianSlim('3.12')
      .pipInstall(['pandas', 'numpy'])
      .workdir('/home/daytona')

    // スナップショットを作成し、ビルドログをストリーム出力
    await daytona.snapshot.create(
      {
          name: snapshotName,
          image,
      },
      {
          onLogs: console.log,
      }
    )

    // 事前構築済みのスナップショットから新しいサンドボックスを作成
    const sandbox = await daytona.create({
      snapshot: snapshotName,
    })
    ```
  </TabItem>
</Tabs>

参照: [CreateSnapshotParams (Python SDK)](/docs/python-sdk/sync/snapshot#createsnapshotparams), [CreateSnapshotParams (TypeScript SDK)](/docs/typescript-sdk/snapshot#createsnapshotparams)

## イメージの構成 \{#image-configuration\}

Daytona SDK には、イメージをプログラムで定義するためのメソッドが用意されています。ベースイメージの指定、パッケージのインストール、ファイルの追加、環境変数の設定などを行えます。

完全な API リファレンスとメソッドシグネチャについては、[Python](/docs/python-sdk/common/image) および [TypeScript](/docs/typescript-sdk/image) の SDK リファレンスを参照してください。

### ベースイメージの選択 \{#base-image-selection\}

次の例は、ベースイメージの選択と構成方法を示します：

<Tabs syncKey="language">
  <TabItem label="Python" icon="seti:python">
    ```python
    # ベースイメージから作成
    image = Image.base("python:3.12-slim-bookworm")

    # Python 3.12 を含む Debian slim イメージを使用
    image = Image.debian_slim("3.12")
    ```
  </TabItem>

  <TabItem label="TypeScript" icon="seti:typescript">
    ```typescript
    // ベースイメージから作成
    const image = Image.base('python:3.12-slim-bookworm')

    // Python 3.12 を含む Debian slim イメージを使用
    const image = Image.debianSlim('3.12')
    ```
  </TabItem>
</Tabs>

参照: [base (Python SDK)](/docs/python-sdk/common/image#imagebase)、[debian&#95;slim (Python SDK)](/docs/python-sdk/common/image#imagedebian_slim)、[base (TypeScript SDK)](/docs/typescript-sdk/image#base)、[debianSlim (TypeScript SDK)](/docs/typescript-sdk/image#debianslim)

### パッケージ管理 \{#package-management\}

次の方法で Python パッケージと依存関係をインストールします。

<Tabs syncKey="language">
  <TabItem label="Python" icon="seti:python">
    ```python
    # pip パッケージを追加
    image = Image.debian_slim("3.12").pip_install("requests", "pandas")

    # requirements.txt からインストール
    image = Image.debian_slim("3.12").pip_install_from_requirements("requirements.txt")

    # pyproject.toml からインストール（オプション依存関係あり）
    image = Image.debian_slim("3.12").pip_install_from_pyproject("pyproject.toml", optional_dependencies=["dev"])
    ```
  </TabItem>

  <TabItem label="TypeScript" icon="seti:typescript">
    ```typescript
    // pip パッケージを追加
    const image = Image.debianSlim('3.12').pipInstall(['requests', 'pandas'])

    // requirements.txt からインストール
    const image = Image.debianSlim('3.12').pipInstallFromRequirements('requirements.txt')

    // pyproject.toml からインストール（オプション依存関係あり）
    const image = Image.debianSlim('3.12').pipInstallFromPyproject('pyproject.toml', { 
      optionalDependencies: ['dev'] 
    })
    ```
  </TabItem>
</Tabs>

参照: [pip&#95;install (Python SDK)](/docs/python-sdk/common/image#imagepip_install)、[pip&#95;install&#95;from&#95;requirements (Python SDK)](/docs/python-sdk/common/image#imagepip_install_from_requirements)、[pip&#95;install&#95;from&#95;pyproject (Python SDK)](/docs/python-sdk/common/image#imagepip_install_from_pyproject)、[pipInstall (TypeScript SDK)](/docs/typescript-sdk/image#pipinstall)、[pipInstallFromRequirements (TypeScript SDK)](/docs/typescript-sdk/image#pipinstallfromrequirements)、[pipInstallFromPyproject (TypeScript SDK)](/docs/typescript-sdk/image#pipinstallfrompyproject)

### ファイルシステム操作 \{#file-system-operations\}

以下の例では、イメージにファイルやディレクトリを追加する方法を示します。

<Tabs syncKey="language">
  <TabItem label="Python" icon="seti:python">
    ```python
    # ローカルファイルを追加
    image = Image.debian_slim("3.12").add_local_file("package.json", "/home/daytona/package.json")

    # ローカルディレクトリを追加
    image = Image.debian_slim("3.12").add_local_dir("src", "/home/daytona/src")
    ```
  </TabItem>

  <TabItem label="TypeScript" icon="seti:typescript">
    ```typescript
    // ローカルファイルを追加
    const image = Image.debianSlim('3.12').addLocalFile('package.json', '/home/daytona/package.json')

    // ローカルディレクトリを追加
    const image = Image.debianSlim('3.12').addLocalDir('src', '/home/daytona/src')
    ```
  </TabItem>
</Tabs>

参照: [add&#95;local&#95;file (Python SDK)](/docs/python-sdk/common/image#imageadd_local_file), [add&#95;local&#95;dir (Python SDK)](/docs/python-sdk/common/image#imageadd_local_dir), [addLocalFile (TypeScript SDK)](/docs/typescript-sdk/image#addlocalfile), [addLocalDir (TypeScript SDK)](/docs/typescript-sdk/image#addlocaldir)

### 環境設定 \{#environment-configuration\}

以下の方法で環境変数と作業ディレクトリを設定します:

<Tabs syncKey="language">
  <TabItem label="Python" icon="seti:python">
    ```python
    # 環境変数を設定
    image = Image.debian_slim("3.12").env({"PROJECT_ROOT": "/home/daytona"})

    # 作業ディレクトリを設定
    image = Image.debian_slim("3.12").workdir("/home/daytona")
    ```
  </TabItem>

  <TabItem label="TypeScript" icon="seti:typescript">
    ```typescript
    // 環境変数を設定
    const image = Image.debianSlim('3.12').env({ PROJECT_ROOT: '/home/daytona' })

    // 作業ディレクトリを設定
    const image = Image.debianSlim('3.12').workdir('/home/daytona')
    ```
  </TabItem>
</Tabs>

参照: [env（Python SDK）](/docs/python-sdk/common/image#imageenv)、[workdir（Python SDK）](/docs/python-sdk/common/image#imageworkdir)、[env（TypeScript SDK）](/docs/typescript-sdk/image#env)、[workdir（TypeScript SDK）](/docs/typescript-sdk/image#workdir)

### コマンドとエントリポイント \{#commands-and-entrypoints\}

ビルド時にコマンドを実行し、コンテナの起動時の挙動を設定します:

<Tabs syncKey="language">
  <TabItem label="Python" icon="seti:python">
    ```python
    # ビルド時にシェルコマンドを実行
    image = Image.debian_slim("3.12").run_commands(
        'apt-get update && apt-get install -y git',
        'groupadd -r daytona && useradd -r -g daytona -m daytona',
        'mkdir -p /home/daytona/workspace'
    )

    # エントリポイントを設定
    image = Image.debian_slim("3.12").entrypoint(["/bin/bash"])

    # デフォルトのコマンドを設定
    image = Image.debian_slim("3.12").cmd(["/bin/bash"])
    ```
  </TabItem>

  <TabItem label="TypeScript" icon="seti:typescript">
    ```typescript
    // ビルド時にシェルコマンドを実行
    const image = Image.debianSlim('3.12').runCommands(
        'apt-get update && apt-get install -y git',
        'groupadd -r daytona && useradd -r -g daytona -m daytona',
        'mkdir -p /home/daytona/workspace'
    )

    // エントリポイントを設定
    const image = Image.debianSlim('3.12').entrypoint(['/bin/bash'])

    // デフォルトのコマンドを設定
    const image = Image.debianSlim('3.12').cmd(['/bin/bash'])
    ```
  </TabItem>
</Tabs>

参照: [run&#95;commands (Python SDK)](/docs/python-sdk/common/image#imagerun_commands)、[entrypoint (Python SDK)](/docs/python-sdk/common/image#imageentrypoint)、[cmd (Python SDK)](/docs/python-sdk/common/image#imagecmd)、[runCommands (TypeScript SDK)](/docs/typescript-sdk/image#runcommands)、[entrypoint (TypeScript SDK)](/docs/typescript-sdk/image#entrypoint)、[cmd (TypeScript SDK)](/docs/typescript-sdk/image#cmd)

### Dockerfile の統合 \{#dockerfile-integration\}

既存の Dockerfile を取り込む、またはカスタムの Dockerfile コマンドを追加する:

<Tabs syncKey="language">
  <TabItem label="Python" icon="seti:python">
    ```python
    # カスタムの Dockerfile コマンドを追加
    image = Image.debian_slim("3.12").dockerfile_commands(["RUN echo 'Hello, world!'"])

    # 既存の Dockerfile を使用
    image = Image.from_dockerfile("Dockerfile")

    # 既存の Dockerfile を拡張
    image = Image.from_dockerfile("app/Dockerfile").pip_install(["numpy"])
    ```
  </TabItem>

  <TabItem label="TypeScript" icon="seti:typescript">
    ```typescript
    // カスタムの Dockerfile コマンドを追加
    const image = Image.debianSlim('3.12').dockerfileCommands(['RUN echo "Hello, world!"'])

    // 既存の Dockerfile を使用
    const image = Image.fromDockerfile('Dockerfile')

    // 既存の Dockerfile を拡張
    const image = Image.fromDockerfile("app/Dockerfile").pipInstall(['numpy'])
    ```
  </TabItem>
</Tabs>

参照: [dockerfile&#95;commands (Python SDK)](/docs/python-sdk/common/image#imagedockerfile_commands)、[from&#95;dockerfile (Python SDK)](/docs/python-sdk/common/image#imagefrom_dockerfile)、[dockerfileCommands (TypeScript SDK)](/docs/typescript-sdk/image#dockerfilecommands)、[fromDockerfile (TypeScript SDK)](/docs/typescript-sdk/image#fromdockerfile)

## ベストプラクティス \{#best-practices\}

宣言的ビルダーを使用する際は、次のベストプラクティスに従ってください：

1. **レイヤーの最適化**：関連する処理をまとめて Docker レイヤーを最小化する
2. **キャッシュの活用**：同一のビルドコマンドとコンテキストはキャッシュされ、以降のビルドはほぼ即時に完了する
3. **セキュリティ**：アプリケーションのワークロード用に非 root ユーザーを作成する
4. **リソース効率**：適切な場合はスリムなベースイメージを使用する
5. **コンテキストの最小化**：ビルドコンテキストには必要なファイルのみを含める