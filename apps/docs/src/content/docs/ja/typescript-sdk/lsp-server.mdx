---
title: "LSPサーバー"
hideTitleOnPage: true
---

## LspServer \{#lspserver\}

コードインテリジェンスのために LSP (言語サーバープロトコル) の機能を提供し、
コード補完やシンボル検索など、IDE さながらの機能を利用できるようにします。

### コンストラクタ \{#constructors\}

#### new LspServer() \{#new-lspserver\}

```ts
new LspServer(
   languageId: LspLanguageId, 
   pathToProject: string, 
   toolboxApi: ToolboxApi, 
   sandboxId: string): LspServer
```

**パラメータ**:

* `languageId` *LspLanguageId*
* `pathToProject` *string*
* `toolboxApi` *ToolboxApi*
* `sandboxId` *string*

**戻り値**:

* `LspServer`

### メソッド \{#methods\}

#### completions() \{#completions\}

```ts
completions(path: string, position: Position): Promise<CompletionList>
```

ファイル内の特定位置で補完候補を取得します。

**パラメーター**:

* `path` *string* - ファイルパス。相対パスは、LSP サーバーのコンストラクタで設定されたプロジェクトパスを基準に解決されます。
* `position` *Position* - 補完を要求したファイル内の位置

**戻り値**:

* `Promise<CompletionList>` - 補完候補のリスト。リストには次が含まれます:
  * isIncomplete: さらに項目が取得可能な可能性があるかどうか
  * items: 補完項目のリスト（各項目には以下を含む）:
  * label: 挿入するテキスト
  * kind: 補完の種類
  * detail: 項目に関する追加情報
  * documentation: 項目のドキュメント
  * sortText: リスト内で項目をソートするためのテキスト
  * filterText: 項目をフィルタリングするためのテキスト
  * insertText: 実際に挿入されるテキスト（label と異なる場合）

**例:**

```ts
// 特定の位置での補完を取得
const completions = await lsp.completions('workspace/project/src/index.ts', {
  line: 10,
  character: 15
});
completions.items.forEach(item => {
  console.log(`${item.label} (${item.kind}): ${item.detail}`);
});
```

***

#### didClose() \{#didclose\}

```ts
didClose(path: string): Promise<void>
```

エディタでファイルを閉じた際に呼び出し、言語サーバーにファイルが閉じられたことを通知して、そのファイルに関連するリソースのクリーンアップを行えるようにします。

**パラメーター**:

* `path` *string* - 閉じたファイルへのパス。相対パスは、LSP サーバーのコンストラクタで設定されたプロジェクトパスを基準に解決されます。

**戻り値**:

* `Promise<void>`

**例:**

```ts
// ファイルの編集が完了したとき
await lsp.didClose('workspace/project/src/index.ts');
```

***

#### didOpen() \{#didopen\}

```ts
didOpen(path: string): Promise<void>
```

言語サーバーにファイルのオープンを通知し、そのファイルに対する診断や補完などの言語機能を有効化します。サーバーは当該ファイルの内容を追跡し、言語機能の提供を開始します。

**パラメーター**:

* `path` *string* - 開いたファイルのパス。相対パスはサンドボックスの作業ディレクトリを基準に解決されます。

**戻り値**:

* `Promise<void>`

**例:**

```ts
// ファイルを編集用に開く際
await lsp.didOpen('workspace/project/src/index.ts');
// これで、このファイルに対して補完、シンボルなどを取得できます
```

***

#### documentSymbols() \{#documentsymbols\}

```ts
documentSymbols(path: string): Promise<LspSymbol[]>
```

ドキュメントからシンボル情報（関数、クラス、変数など）を取得します。

**パラメータ**:

* `path` *string* - シンボルを取得する対象ファイルへのパス。相対パスは、LSPサーバーのコンストラクターで設定したプロジェクトパスを基準に解決されます。

**戻り値**:

* `Promise<LspSymbol[]>` - ドキュメント内のシンボル一覧。各シンボルには以下が含まれます:
  * name: シンボル名
  * kind: シンボルの種別（関数、クラス、変数など）
  * location: ファイル内での位置

**例:**

```ts
// ファイル内のすべてのシンボルを取得
const symbols = await lsp.documentSymbols('workspace/project/src/index.ts');
symbols.forEach(symbol => {
  console.log(`${symbol.kind} ${symbol.name}: ${symbol.location}`);
});
```

***

#### sandboxSymbols() \{#sandboxsymbols\}

```ts
sandboxSymbols(query: string): Promise<LspSymbol[]>
```

クエリ文字列に一致するシンボルをサンドボックス全体で検索します。

**パラメータ**:

* `query` *string* - シンボル名に照合する検索クエリ

**戻り値**:

* `Promise<LspSymbol[]>` - すべてのファイルから一致したシンボルのリスト。各シンボルには次が含まれます:
  * name: シンボル名
  * kind: シンボルの種類（function、class、variable など）
  * location: ファイル内での位置

**例:**

```ts
// "User"を含むすべてのシンボルを検索
const symbols = await lsp.sandboxSymbols('User');
symbols.forEach(symbol => {
  console.log(`${symbol.name} (${symbol.kind}) in ${symbol.location}`);
});
```

***

#### start() \{#start\}

```ts
start(): Promise<void>
```

言語サーバーを起動します。他の LSP 機能を使用する前に必ず呼び出してください。
指定した言語とプロジェクトの言語サーバーを初期化します。

**戻り値**:

* `Promise<void>`

**例:**

```ts
const lsp = await sandbox.createLspServer('typescript', 'workspace/project');
await lsp.start();  // サーバーを初期化
// LSP操作の準備完了
```

***

#### stop() \{#stop\}

```ts
stop(): Promise<void>
```

言語サーバーを停止します。LSPサーバーが不要になった際に呼び出して、
システムリソースを解放します。

**戻り値**:

* `Promise<void>`

**例:**

```ts
// LSP機能の使用が完了したとき
await lsp.stop();  // リソースをクリーンアップ
```

***

#### ~~workspaceSymbols()~~ \{#workspacesymbols\}

```ts
workspaceSymbols(query: string): Promise<LspSymbol[]>
```

クエリ文字列に一致するシンボルをサンドボックス全体から検索します。

**パラメーター**:

* `query` *string* - シンボル名に対して照合する検索クエリ

**戻り値**:

* `Promise<LspSymbol[]>` - すべてのファイルから一致したシンボルの一覧。各シンボルには以下が含まれます:
  * name: シンボル名
  * kind: シンボルの種別（function、class、variable など）
  * location: ファイル内での位置

##### 非推奨 \{#deprecated\}

代わりに `sandboxSymbols` を使用してください。このメソッドは今後のバージョンで削除されます。

***

## LspLanguageId \{#lsplanguageid\}

サポートされる言語サーバーの種類。

**列挙メンバー**:

* `JAVASCRIPT` (&quot;javascript&quot;)
* `PYTHON` (&quot;python&quot;)
* `TYPESCRIPT` (&quot;typescript&quot;)

## 位置 \{#position\}

テキストドキュメント内の0始まりの位置を表し、
行番号と文字オフセットで指定します。

**プロパティ**:

* `character` *number* - 行内の0始まりの文字オフセット
* `line` *number* - ドキュメント内の0始まりの行番号

**例:**

```ts
const position: Position = {
  line: 10,     // 11行目 (0ベース)
  character: 15  // 行の16文字目 (0ベース)
};
```
