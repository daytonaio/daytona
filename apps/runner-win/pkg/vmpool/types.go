// Copyright 2025 Daytona Platforms Inc.
// SPDX-License-Identifier: AGPL-3.0

package vmpool

import (
	"time"
)

// PoolVMState represents the state of a VM in the pool
type PoolVMState string

const (
	// PoolVMStateAvailable means the VM is paused and ready to be claimed
	PoolVMStateAvailable PoolVMState = "available"
	// PoolVMStateClaimed means the VM has been claimed by a sandbox
	PoolVMStateClaimed PoolVMState = "claimed"
	// PoolVMStateCreating means the VM is being created
	PoolVMStateCreating PoolVMState = "creating"
)

// Pool VM naming constants
const (
	// PoolVMNamePrefix is the prefix for pool VM names
	// Total length should be 15 chars to match golden template (e.g., "golden-template")
	PoolVMNamePrefix = "pool-vm-"
	// PoolVMNameLength is the total length of pool VM names
	PoolVMNameLength = 15
)

// PoolVM represents a VM in the pool
type PoolVM struct {
	// Name is the pool tracking name (e.g., "pool-vm-0000001")
	Name string
	// DomainName is the actual libvirt domain name (e.g., "sndbx-xxxxxxxxx")
	// This is generated by memory snapshot creation and differs from Name
	DomainName string
	// UUID is the libvirt domain UUID
	UUID string
	// IP is the VM's IP address
	IP string
	// MAC is the VM's MAC address
	MAC string
	// State is the current state of the VM in the pool
	State PoolVMState
	// SandboxID is the sandbox ID if the VM has been claimed (empty if available)
	SandboxID string
	// CreatedAt is when the VM was created
	CreatedAt time.Time
	// ClaimedAt is when the VM was claimed (zero if not claimed)
	ClaimedAt time.Time
}

// PoolConfig holds configuration for the VM pool
type PoolConfig struct {
	// Size is the target number of VMs to keep in the pool
	Size int
	// WatchInterval is how often to check and replenish the pool
	WatchInterval time.Duration
}

// PoolStats contains statistics about the pool
type PoolStats struct {
	// TargetSize is the configured pool size
	TargetSize int
	// Available is the number of VMs ready to be claimed
	Available int
	// Claimed is the number of VMs currently in use
	Claimed int
	// Creating is the number of VMs being created
	Creating int
}

// IsEnabled returns true if the pool is enabled (size > 0)
func (c *PoolConfig) IsEnabled() bool {
	return c.Size > 0
}
