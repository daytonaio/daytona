# Copyright 2025 Daytona Platforms Inc.
# SPDX-License-Identifier: Apache-2.0

# DO NOT EDIT THIS FILE MANUALLY.
# This file is auto-generated by the unasync conversion script.
# Edit the async source and re-run this script.

import json
import sys
import traceback
from typing import List

from daytona_api_client import CreateDiskDto, DisksApi, ForkDiskDto

from ..common.disk import Disk
from ..common.errors import DaytonaError


class DiskService:
    """Service for managing Daytona Disks. Can be used to list, get, create and delete Disks."""

    def __init__(self, disks_api: DisksApi):
        self.__disks_api = disks_api

    def list(self) -> List[Disk]:
        """List all Disks.

        Returns:
            List[Disk]: List of all Disks.

        Example:
            ```python
            daytona = Daytona()
            disks = daytona.disk.list()
            for disk in disks:
                print(f"{disk.name} ({disk.id}) - {disk.size}GB")
            ```
        """
        disks = self.__disks_api.list_disks()
        return [Disk.from_dto(disk) for disk in disks]

    def get(self, disk_id: str) -> Disk:
        """Get a Disk by ID.

        Args:
            disk_id (str): ID of the Disk to get.

        Returns:
            Disk: The Disk object.

        Example:
            ```python
            daytona = Daytona()
            disk = daytona.disk.get("disk-id")
            print(f"{disk.name} ({disk.id}) - {disk.size}GB")
            ```
        """
        disk_dto = self.__disks_api.get_disk(disk_id)
        if disk_dto is None:
            raise DaytonaError(f"Failed to get disk: API returned no data for disk ID {disk_id}")
        return Disk.from_dto(disk_dto)

    def create(self, name: str, size: int) -> Disk:
        """Create a new Disk.

        Args:
            name (str): Name of the Disk to create.
            size (int): Size of the Disk in GB.

        Returns:
            Disk: The Disk object.

        Example:
            ```python
            daytona = Daytona()
            disk = daytona.disk.create("test-disk", 50)
            print(f"{disk.name} ({disk.id}); state: {disk.state}; size: {disk.size}GB")
            ```
        """
        disk_dto = self.__disks_api.create_disk(CreateDiskDto(name=name, size=size))
        if disk_dto is None:
            raise DaytonaError(f"Failed to create disk: API returned no data for disk name {name}")
        return Disk.from_dto(disk_dto)

    def delete(self, disk: Disk) -> None:
        """Delete a Disk.

        Args:
            disk (Disk): Disk to delete.

        Example:
            ```python
            daytona = Daytona()
            disk = daytona.disk.get("test-disk")
            daytona.disk.delete(disk)
            print("Disk deleted")
            ```
        """
        self.__disks_api.delete_disk(disk.id)

    def fork(self, disk: Disk, new_disk_name: str) -> Disk:
        """Fork a Disk to create a new disk that shares all existing layers.

        Creates a new disk that shares all existing layers of the source disk.
        Both disks will have independent write layers for independent operation.

        Args:
            disk (Disk): Source disk to fork.
            new_disk_name (str): Name for the new disk (can be any value).

        Returns:
            Disk: The newly created forked disk.

        Example:
            ```python
            daytona = Daytona()
            source_disk = daytona.disk.get("source-disk")
            new_disk = daytona.disk.fork(source_disk, "new-disk-name")
            print(f"Forked disk {new_disk.name} from {source_disk.name}")
            ```
        """
        try:
            api_response = self.__disks_api.fork_disk_with_http_info(disk.id, ForkDiskDto(new_disk_name=new_disk_name))

            if api_response.raw_data:
                try:
                    raw_json = api_response.raw_data.decode("utf-8")
                    print(f"[DEBUG] Raw Response Body: {raw_json}", file=sys.stderr)
                    try:
                        json.loads(raw_json)
                    except json.JSONDecodeError as e:
                        print(f"[DEBUG] Failed to parse JSON: {e}", file=sys.stderr)
                except Exception as e:
                    print(f"[DEBUG] Failed to decode raw_data: {e}", file=sys.stderr)
                    print(f"[DEBUG] Raw data type: {type(api_response.raw_data)}", file=sys.stderr)
                    print(
                        f"[DEBUG] Raw data length: {len(api_response.raw_data) if api_response.raw_data else 0}",
                        file=sys.stderr,
                    )

            disk_dto = api_response.data
            if disk_dto is None:
                raise DaytonaError("Failed to fork disk: API returned no data")
            return Disk.from_dto(disk_dto)
        except Exception as e:
            print(f"[DEBUG] Exception during fork: {type(e).__name__}: {e}", file=sys.stderr)
            print(f"[DEBUG] Traceback: {traceback.format_exc()}", file=sys.stderr)
            raise
